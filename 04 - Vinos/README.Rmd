---
title: "Vinos"
author: "Elio Campitelli"
output: github_document
---

Como siempre, primero leo los datos. 

```{r}
library(data.table)
library(ggplot2)
library(magrittr)
library(hrbrthemes)

vinos <- fread("https://raw.githubusercontent.com/cienciadedatos/datos-de-miercoles/master/datos/2019/2019-06-12/vinos.csv")

name <- knitr::current_input(dir = TRUE)
name <- strsplit(name, "/", fixed = TRUE)[[1]]
dir <- name[length(name) - 1]
dir <- stringi::stri_replace_all(dir, "%20", fixed = " ")

url <- paste0("https://github.com/eliocamp/ddm/tree/master/", dir)

library(spindler)
this_thread <- thread$new(tag = "tw")$
  add_post(paste0("Hola, #DatosDeMi√©rcoles. Esta semana vamos a brindarcon datos de reviews de vinos! ", emo::ji("wine"), "\n",
                  "A penas vi los datos lo primero que quise hacer fue evaluar la consistencia de los puntajes de vino. Veamos si puedo! \n #rstats #rstatsES"))
```

Apenas le√≠ que este Datos de Mi√©rcoles era sobre vinos, lo primero que quise evaluar es la consistencia en el puntaje de un mismo vino. Viendo los datos, resulta que no es tan f√°cil. Pero vamos a ver si puedo hacer algo. ¬øQu√© identifica a cada vino? Supongo que el nombre. Pero quiz√°s hay m√°s de una marca que le puso el mismo nombre? Hay que ver. 

```{r, tw = 'Mirando los datos, no ser√≠a muy f√°cil. ¬øC√≥mo se identifica cada vino? La variable "nombre" podr√≠a servir pero no parece. Nombres como "Reserva" son hiper comunes.'}
vinos[, .N, by = nombre][order(-N)][1:10] %>% 
  .[complete.cases(.)] %>% 
  ggplot(aes(nombre, N)) +
  geom_col()
```

Muchos NAs, ok. Pero tambi√©n much√≠simos con nombre "Reserve" o "Riserva", etc... Es seguro que estos no son los mismos vinos. Pero tenemos tambi√©n la variedad y el vi√±edo,  

```{r, fig.height=5, tw = "Pero la combinaci√≥n de nombre + variedad + vi√±edo s√≠ parece que da vinos √∫nicos!"}
vinos[, .N, by = .(nombre, vina, variedad)][order(-N)] %>% 
  .[complete.cases(.)] %>% 
  .[1:10] %>%
  .[, vino := paste0(nombre, " \n(", variedad, " de ", vina, ")")] %>% 
  ggplot(aes(vino, N)) +
    geom_col() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
```


Ok, eso podr√≠a ser mejor. Veamos por ejemplo los datos de uno en particular
```{r}
this_thread$add_post(paste0("Los nombres de las rese√±as tienen el a√±o en que se hizo y en la versi√≥n larga (que pueden encontrar ac√°: ", url, ") arm√© una funci√≥n que usa expresiones regulares para extraerla, pero al final no lo us√©", emo::ji("shrug")))
```


```{r}
vinos[nombre == "S√©lection" & vina == "Georges Duboeuf" & variedad == "Gamay"] %>% 
  .[, .(nombre, vina, variedad, titulo_resena)] %>% 
  .[1:5] %>% 
  knitr::kable()
```

Ok! Tenemos m√∫ltiples reviews de un mismo vino en distintos a√±os. Esto se pone bueno! Voy a manipular las cosas para separar el a√±o de la rese√±a. Vamos a usar expresiones regulares para capturar todo lo que sean cuatro d√≠gitos. Chequeo un par para ver que haya salido bien:

```{r}
library(stringi)
vinos[, anio := as.numeric(stri_extract(titulo_resena, regex = "\\d{4}"))]
set.seed(42)
vinos[sample(1:.N, 15), .(anio, titulo_resena)] %>% 
  knitr::kable()
```

Vemos el rango... 

```{r}
range(vinos$anio, na.rm = TRUE)
```



Ups. Adem√°s de que hay NAs (algunos que no encontr√≥ un a√±o) hay algunos que est√°n mal. Posiblemente el nombre del vino tenga 4 d√≠gitos o algo as√≠. Hay que sanitizar un poco.

```{r}
# Ning√∫n a√±o puede ser mayor a 2019
vinos[anio > 2019, anio := NA]
```

A ver...

```{r}
ggplot(vinos, aes(anio)) +
  geom_histogram()
```

Hay mcuhos con "a√±o" muy bajo a ver qu√© pasa:

```{r}
vinos[order(anio)][1:10][, .(nombre, vina, variedad, titulo_resena)] %>% 
  knitr::kable()
```

Ah√≠ va. Tienen un n√∫mero enel nombre o la vina. Esto es un problema... podr√≠a simplemente borrarlos, total hay muchos que son v√°lidos, pero me gustar√≠a tratar algo. Voy a hacer una funci√≥n que detecte todas las 4 cifras posibles en el t√≠tulo de la rese√±a, las compare con los n√∫meros que est√°n en el nombre o la vi√±a y elimine las que son iguales. Si queda una sola, asumo que es el a√±o, si no hay nada o hay m√°s de una, no puedo saber nada y le dejo NA.

```{r}
resenia_a_anio <- function(titulo, nombre, vina) {
  anio_titulo <- stri_extract_all(titulo, regex = "\\d{4}")
  anio_nombre <- stri_extract_all(nombre, regex = "\\d{4}")
  anio_vina <- stri_extract_all(vina, regex = "\\d{4}")
  
  anio <- vapply(seq_along(anio_titulo), function(i) {
    repetido <- anio_titulo[[i]] %in% c(anio_nombre[[i]], anio_vina[[i]])
    anio_posible <-  anio_titulo[[i]][!repetido]
    
    if (length(anio_posible) != 1) {
      anio_posible <- NA
    }
    
    return(as.numeric(anio_posible))
    
  }, 1)
  return(anio)
}

vinos[, anio := resenia_a_anio(titulo_resena, nombre, vina)]

range(vinos$anio, na.rm = TRUE)
```

Muucho mejor! ¬øCu√°ntas rese√±as por a√±o?

```{r}
vinos[, .N, by = anio] %>% 
  ggplot(aes(anio, N)) +
  geom_line()
```

Esperable, la enorme mayor√≠a son de los √∫ltimos 20 a√±os. Bien, ahora se viene lo bueno. Veamos el puntaje de cada vino. Primero, necesito vinos con muchas reviews repetidas, ¬øc√≥mo estamos con eso?

```{r}
vinos %>% 
  .[, .(anio, puntos, nombre, variedad, vina)] %>% 
  .[complete.cases(.)] %>% 
  .[, .N, by = .(nombre, variedad, vina)] %>% 
  .[order(-N)] %>% 
  .[1:15] %>% 
  knitr::kable()
```

ü§®. Uff... no son demasiadas. Pero bueno, es lo que hay. 

```{r, tw = "Agarrando los vinos que tienen m√°s de 10 rese√±as, se puede ver que hay bastante variabilidad en los puntajes; los puntajes de algunso vinos tienen un rango de 10 puntos. Para comparar: TODOS los vinos tienen puntaje entre 80 y 100."}
seleccion <- vinos %>% 
  .[, .(anio, puntos, cuantil = ecdf(puntos)(puntos), nombre, variedad, vina)] %>% 
  .[complete.cases(.)] %>% 
  .[, N := .N, by = .(nombre, variedad, vina)] %>% 
  .[N > 10] %>% 
  .[, vino := as.numeric(interaction(nombre, variedad, vina))]
  
copy(seleccion) %>% 
  .[, puntos_medio := mean(puntos), by = vino] %>% 
  .[, vino := reorder(vino, -puntos_medio)] %>% 
  ggplot(aes(vino, puntos)) + 
  geom_jitter(width = 0.2, size = 0.9, aes(color = vino)) +
  scale_y_continuous("Puntaje", limits = c(80, 100)) +
  scale_color_discrete(guide = "none") +
  scale_x_discrete("Vino") +
  hrbrthemes::theme_ipsum_rc() +
  labs(title = "¬øCu√°nta consistencia hay en las calificaciones de vinos?")
```


Le puse un n√∫mero medio aleatorio a cada vino porque no me interesa el nombre o el tipo de vino (tampoco s√© de vinos, as√≠ que no me ser√≠a de ayuda). Se ve que hay un spread interesante en cada vino. El rango gr√°fico muestra todo el rango usado por todos los vinos (de 80 a 100), y se ve que los puntajes de algunos vinos cubren casi la mitad de ese rango!

El efecto se puede apreciar convirtiendo los puntajes en cuantiles. La variabilidad es muy grande, haciendo que un vino pueda estar en el top 10% o en el bottom 30%.

```{r, tw = "Para poner la diferencias en contexto, ac√° se ve lo mismo que antes pero en t√©rminos del cuantil del puntaje. El mismo vino puede parte del 10% mejor y del 30% peor al mismo tiempo. \n Moraleja: no hay que darle demasiada importancia a los puntajes de los vinos."}
copy(seleccion) %>% 
  .[, puntos_medio := mean(cuantil), by = vino] %>% 
  .[, vino := reorder(vino, -puntos_medio)] %>% 
  ggplot(aes(vino, cuantil)) + 
  geom_jitter(width = 0.2, size = 0.9, aes(color = vino)) +
  scale_y_continuous("Puntaje (cuantil)", limits = c(0, 1)) +
  scale_color_discrete(guide = "none") +
  scale_x_discrete("Vino") +
  hrbrthemes::theme_ipsum_rc() +
  labs(title = "Los vinos de Schr√∂dinger",
       subtitle = "Un mismo vino puede estar en el top 10% y en el bottom 30%.")
```

```{r}
this_thread$add_post(paste0("Con estos #DatosDeMi√©rcoles entonces aprend√≠mos que, al menos para los vinos ma≈õ o menos buenos, los puntajes son muy poco importantes.\n El c√≥digo fuente de este hilolo pueden ver encontrar en ", url))$
  add_post("PD: Hice este thread directamente desde knitr con el paquete spindler: https://git.io/fjzxN \n #rstats #rstatsES")
```



Al final no us√© los a√±os que tanto me cost√≥ conseguir (?), pero bueno. 

```{r}
this_thread$publish()

saveRDS(this_thread, "~/thread.Rds")
```

